# Plan: E2E Testing Infrastructure and Critical Flow Tests

**Phase:** 1 - E2E Testing
**Requirements:** TEST-01, TEST-02, TEST-03, TEST-04, TEST-05, TEST-06, TEST-07
**Estimated tasks:** 7

## Summary

This plan establishes the complete Playwright E2E testing infrastructure for RecruitOS and implements all 6 critical flow test suites (Intake, Search, Pipeline, Profile, Outreach, Social Matrix). The goal is to have automated tests that pass without flakiness in under 5 minutes.

## Dependencies

- None (first phase)
- Existing codebase at commit 55a6ff2 (feature/social-matrix branch)

## Tasks

### Task 1: Playwright Infrastructure Setup

**Goal:** Configure Playwright with proper project structure, authentication mocking, and parallel execution settings.

**Files:**
- `playwright.config.ts` (create)
- `tests/e2e/setup/auth.setup.ts` (create)
- `tests/e2e/setup/global.setup.ts` (create)
- `.gitignore` (update - add playwright/.auth/)
- `package.json` (update - add Playwright dev dependency and scripts)

**Steps:**
1. Install Playwright: `npm install -D @playwright/test && npx playwright install chromium`
2. Create `playwright.config.ts` with:
   - `testDir: './tests/e2e'`
   - `fullyParallel: true`
   - `workers: process.env.CI ? 2 : undefined`
   - `retries: process.env.CI ? 2 : 0`
   - `webServer` pointing to `npm run dev` on port 3000
   - Storage state setup for authentication
3. Create `tests/e2e/setup/auth.setup.ts` that:
   - Sets localStorage values for admin mode, credits (10000), and mocked session
   - Saves storage state to `playwright/.auth/user.json`
4. Create `tests/e2e/setup/global.setup.ts` for any global test configuration
5. Add `playwright/.auth/` to `.gitignore`
6. Add scripts to `package.json`:
   - `"test:e2e": "playwright test"`
   - `"test:e2e:ui": "playwright test --ui"`
   - `"test:e2e:headed": "playwright test --headed"`

**Done when:**
- `npm run test:e2e -- --project=setup` runs successfully
- Storage state file created at `playwright/.auth/user.json`
- Playwright config loads without errors

---

### Task 2: Page Object Models

**Goal:** Create reusable Page Object Model classes for all critical pages to centralize selectors and actions.

**Files:**
- `tests/e2e/pages/IntakePage.ts` (create)
- `tests/e2e/pages/SearchPage.ts` (create)
- `tests/e2e/pages/PipelinePage.ts` (create)
- `tests/e2e/pages/ProfilePage.ts` (create)
- `tests/e2e/pages/index.ts` (create - barrel export)

**Steps:**
1. Create `IntakePage.ts`:
   - Locators: loadDemoButton, jobUrlInput, jobTextArea, analyzeButton, initializePipelineButton, requiredSkillsBadges, calibrationSuccess
   - Methods: `loadDemo()`, `submitJobUrl(url)`, `submitJobText(text)`, `initializePipeline()`, `getCalibrationResult()`

2. Create `SearchPage.ts`:
   - Locators: searchInput, searchButton, developerCards, scoresBadges, loadingSpinner, noResultsMessage
   - Methods: `search(query)`, `getDeveloperCount()`, `getDeveloperByIndex(i)`, `clickDeveloper(username)`

3. Create `PipelinePage.ts`:
   - Locators: candidateCards, scoreDistributionChart, searchInput, addCandidatesButton, filterButtons, shortlistPanel
   - Methods: `getCandidateCount()`, `selectCandidate(id)`, `openCandidateProfile(id)`, `filterByScore(range)`, `addCandidates(query)`

4. Create `ProfilePage.ts`:
   - Locators: profileHeader, skillsBadges, repoCards, psychometricTab, connectionTab, outreachTab, connectionPathCard, findConnectionsButton
   - Methods: `switchToTab(tabName)`, `getSkills()`, `findConnections()`, `generateOutreach()`

5. Create barrel export `index.ts`

**Done when:**
- All 4 page objects compile without TypeScript errors
- Each page object has at least 3 locators and 2 methods
- Import from `tests/e2e/pages` works correctly

---

### Task 3: API Mock Fixtures

**Goal:** Create reusable API mock fixtures for Gemini, GitHub, and BrightData to prevent external API dependencies and rate limiting.

**Files:**
- `tests/e2e/fixtures/mockGeminiResponse.ts` (create)
- `tests/e2e/fixtures/mockGitHubUser.ts` (create)
- `tests/e2e/fixtures/mockGitHubSearch.ts` (create)
- `tests/e2e/fixtures/mockBrightData.ts` (create)
- `tests/e2e/fixtures/mockConnectionPath.ts` (create)
- `tests/e2e/utils/apiMocks.ts` (create)

**Steps:**
1. Create `mockGeminiResponse.ts` with:
   - `mockProfileAnalysis`: alignmentScore, scoreBreakdown, indicators
   - `mockOutreachMessage`: generated message text
   - `mockCalibrationResult`: title, company, requiredSkills, preferredSkills

2. Create `mockGitHubUser.ts` with:
   - `mockDeveloperProfile`: login, name, avatar_url, bio, location, repos, stars, followers
   - `mockRepoList`: array of repo objects with name, description, stars, language

3. Create `mockGitHubSearch.ts` with:
   - `mockSearchResults`: array of developer objects matching API response format

4. Create `mockBrightData.ts` with:
   - `mockLinkedInProfile`: name, headline, location, profileUrl, connectionCount, positions

5. Create `mockConnectionPath.ts` with:
   - `mockSocialMatrix`: nodes, paths, connectionDegree, bestPath

6. Create `apiMocks.ts` utility with:
   - `mockGeminiAPI(page)`: intercepts `/api/profile/analyze`, `/api/calibration`, `/api/outreach`
   - `mockGitHubAPI(page)`: intercepts `/api/search`, `/api/developers/*`, `/api/github/*`
   - `mockBrightDataAPI(page)`: intercepts `/api/brightdata/*`
   - `mockAllAPIs(page)`: calls all mock functions

**Done when:**
- All fixture files export typed mock data
- `mockAllAPIs(page)` can be called in a test without errors
- Mock data matches the TypeScript interfaces used in the app

---

### Task 4: Intake Flow Test (TEST-01)

**Goal:** Test the complete Intake flow: load demo job, analyze requirements, and navigate to skills review.

**Files:**
- `tests/e2e/intake.spec.ts` (create)

**Steps:**
1. Create `intake.spec.ts` with tests:
   - `test('loads demo job context')`: Click "Load Demo", verify calibration card appears with title, company, skills
   - `test('analyzes job from pasted text')`: Paste job description, click analyze, verify skills extracted
   - `test('validates LinkedIn URLs')`: Enter company LinkedIn URL, verify validation indicator
   - `test('navigates to skills review after initialization')`: Complete flow, verify redirect to /skills-review
   - `test('persists job context in localStorage')`: Verify `apex_job_context` is set after initialization

2. Use mock API for `/api/calibration` endpoint to avoid real Gemini calls

3. Each test should:
   - Start with clean localStorage
   - Use web-first assertions (`expect(locator).toBeVisible()`)
   - Have timeout no longer than 15s for any assertion

**Done when:**
- All 5 tests in intake.spec.ts pass
- No hardcoded waits (`waitForTimeout`) used
- Tests run in under 30 seconds total

---

### Task 5: Search and Pipeline Flow Tests (TEST-02, TEST-03)

**Goal:** Test search results display and pipeline management including filtering and candidate selection.

**Files:**
- `tests/e2e/search.spec.ts` (create)
- `tests/e2e/pipeline.spec.ts` (create)

**Steps:**
1. Create `search.spec.ts` with tests:
   - `test('displays search results with scores')`: Search "React TypeScript", verify developer cards with score badges
   - `test('filters by location and language')`: Apply filters, verify filtered results
   - `test('navigates to profile from search result')`: Click developer card, verify navigation to /profile/[username]
   - `test('shows interpretation badges')`: Verify language/location badges from search interpretation

2. Create `pipeline.spec.ts` with tests:
   - `test('loads candidates from localStorage')`: Seed localStorage, verify candidates display
   - `test('filters candidates by score range')`: Click histogram bar, verify filtering
   - `test('selects candidates for comparison')`: Select 2 candidates, verify shortlist panel
   - `test('opens candidate profile inline')`: Expand candidate card, verify deep profile slide-over
   - `test('generates outreach from pipeline')`: Click outreach button, verify modal opens

3. Use mocked `/api/search` to return consistent test data

**Done when:**
- search.spec.ts: 4 tests pass
- pipeline.spec.ts: 5 tests pass
- Combined runtime under 60 seconds

---

### Task 6: Profile and Outreach Flow Tests (TEST-04, TEST-05)

**Goal:** Test profile page tabs and outreach generation flow.

**Files:**
- `tests/e2e/profile.spec.ts` (create)
- `tests/e2e/outreach.spec.ts` (create)

**Steps:**
1. Create `profile.spec.ts` with tests:
   - `test('displays developer stats and skills')`: Navigate to profile, verify stats cards and skill badges
   - `test('shows psychometric profile tab')`: Click Psychometric tab, verify archetype badge
   - `test('shows repository list')`: Verify top repos section with star counts
   - `test('switches between tabs')`: Verify all 4 tabs are accessible (Overview, Psychometric, Connection, Outreach)

2. Create `outreach.spec.ts` with tests:
   - `test('opens outreach modal from pipeline')`: Navigate to pipeline, click outreach, verify modal
   - `test('generates personalized message')`: Mock `/api/outreach`, click generate, verify message appears
   - `test('shows loading state during generation')`: Verify loading spinner during API call
   - `test('displays message template from psychometric')`: Verify outreach tab has message template

3. Mock `/api/profile/analyze` and `/api/outreach` endpoints

**Done when:**
- profile.spec.ts: 4 tests pass
- outreach.spec.ts: 4 tests pass
- Combined runtime under 60 seconds

---

### Task 7: Social Matrix Flow Test (TEST-06)

**Goal:** Test Social Matrix connection path visualization and 6-degrees path display.

**Files:**
- `tests/e2e/social-matrix.spec.ts` (create)

**Steps:**
1. Create `social-matrix.spec.ts` with tests:
   - `test('shows connection path card on profile')`: Navigate to profile, verify ConnectionPathCard component visible
   - `test('fetches connections on button click')`: Click "Find Connections", verify loading then results
   - `test('displays connection degree badge')`: Verify "1st Degree", "2nd Degree", or "3rd+ Degree" badge
   - `test('visualizes path with nodes')`: Verify path visualization with arrow icons between nodes
   - `test('shows warm introduction suggestion')`: If path found, verify warm intro section
   - `test('displays connection badge in search results')`: Search, verify ConnectionBadge on developer cards

2. Mock `/api/github/connection-path` endpoint with mock social matrix data

3. Ensure test works with:
   - Both authenticated (with recruiter GitHub) and unauthenticated flows
   - Various connection degrees (1st, 2nd, 3rd, no path)

**Done when:**
- All 6 tests in social-matrix.spec.ts pass
- Tests verify both loading and success states
- Combined runtime under 45 seconds

---

## Verification (TEST-07)

After all tasks complete:

1. **Run full test suite 3 times consecutively:**
   ```bash
   npm run test:e2e && npm run test:e2e && npm run test:e2e
   ```
   - All 3 runs must pass with 0 failures

2. **Verify test timing:**
   ```bash
   npm run test:e2e -- --reporter=list
   ```
   - Total runtime must be under 5 minutes

3. **Check for flakiness indicators:**
   - No tests should have `retries` > 0 in local runs
   - No `waitForTimeout` calls in test code
   - All selectors use `getByRole`, `getByText`, or `data-testid`

4. **Verify parallel execution:**
   - Tests should show "Running X workers" in output
   - Independent tests should run in parallel

## Success Criteria

- [ ] Playwright config with proper webServer, parallelization, and storage state setup
- [ ] 4 Page Object Model classes with reusable locators and methods
- [ ] API mock fixtures for Gemini, GitHub, BrightData, and Social Matrix
- [ ] 6 test files: intake.spec.ts, search.spec.ts, pipeline.spec.ts, profile.spec.ts, outreach.spec.ts, social-matrix.spec.ts
- [ ] 28 total tests covering all critical flows (TEST-01 through TEST-06)
- [ ] 3 consecutive full test runs with 0 failures (TEST-07)
- [ ] Total test suite runtime under 5 minutes
- [ ] No hardcoded waits or brittle selectors

## Notes

- **Authentication mocking:** Uses storage state with mocked admin mode and credits to avoid real OAuth
- **API mocking strategy:** All external APIs (Gemini, GitHub GraphQL, BrightData) are mocked to prevent rate limiting and ensure consistent test data
- **Parallel execution:** Tests are designed for parallel execution with isolated browser contexts
- **Flakiness prevention:** Uses web-first assertions, role-based selectors, and explicit waits from Playwright's built-in auto-waiting
