# Recruitos Bug Brief ‚Äî 2026-02-18
**Prepared by:** Eureka (based on screen recording + codebase analysis)  
**Branch:** `feature/recruitos-rethink-2026`  
**Severity:** P0 ‚Äî core user flow is broken end-to-end

---

## TL;DR

Three independent bugs make the product unusable in demo and production:

1. **401 on POST /api/candidates** ‚Äî candidates save fails, pipeline shows empty
2. **Skills preview always returns 0** ‚Äî GitHub token missing or rate-limited in production
3. **`tag_alias` console error** ‚Äî skill normalizer fails on "Open Source" input

Plus two UX issues: location filter has no visible effect, and misleading counters ("15 found" but "0 of 11" shown).

---

## Bug 1 ‚Äî P0: POST /api/candidates returns 401 Unauthorized

### What the user sees
- Pipeline header says "15 candidates found"
- Counter shows "0 of 11" but main area shows **"No Candidates Yet"**
- Console: `‚úï POST https://recruitos.xyz/api/candidates  401` ‚Äî repeated **12+ times**
- Also: `AbortError` on one of the requests

### Root cause
`app/api/candidates/route.ts` line 95:
```ts
// POST - Create a new candidate
export async function POST(request: NextRequest) {
  const auth = await requireAuth(); // ‚Üê requireAuth (hard), not requireOptionalAuth
```

The pipeline page is calling `POST /api/candidates` to save search results. But `requireAuth` throws 401 when the session is expired or when running as a demo/unauthenticated user.

### Where it's called from
Look for `fetch('/api/candidates', { method: 'POST' })` in `app/pipeline/page.tsx` ‚Äî this is the call saving GitHub search results to the DB.

### Fix
Option A (recommended): Check if the POST is happening in a demo/public context and allow unauthenticated candidate creation scoped to a session or temp userId:
```ts
// In POST handler
const auth = await requireOptionalAuth();
const userId = auth?.user?.id ?? `demo-${crypto.randomUUID()}`; // fallback for unauthenticated
```

Option B: Ensure the user is always authenticated before the pipeline page renders (redirect to login if session is null). Add an auth gate in `app/pipeline/page.tsx`.

**Note:** The log line `[Pipeline] Saved 11 candidates to API` suggests the pipeline code thinks it succeeded ‚Äî check error handling in the fetch call. It's likely swallowing the 401 silently.

---

## Bug 2 ‚Äî P0: Skills Preview always returns 0 / "no matches" for all skills

### What the user sees
- Skills Review page: every skill (JavaScript, TypeScript, Node.js, React, etc.) shows **"no matches"**
- "Estimated Reachable Candidates: 0"
- Yellow banner fires even for common skills with millions of GitHub users

### Root cause
`app/api/skills/preview/route.ts` calls the GitHub Search API via `octokit`. In **production (Vercel)**, the `GITHUB_TOKEN` env var is either:
- Missing entirely, or
- Being rate-limited (GitHub unauthenticated = 10 req/min vs 30 req/min with token)

When the API throws a 403/429, the code correctly falls back to `getFallbackSkillCount()` ‚Äî BUT the fallback heuristics are only used for the `count` returned to the UI. The per-skill "no matches" label in the skills kanban comes from a **separate** count query that doesn't use the same fallback path.

**Verify:** Check Vercel environment variables at https://vercel.com/arnarssons-projects/skillsync-recruitos/settings/environment-variables
- `GITHUB_TOKEN` ‚Äî must be set for production
- `GITHUB_TOKEN` must not be expired

### Fix
1. **Immediate:** Verify `GITHUB_TOKEN` is set in Vercel production env vars
2. **Code fix:** The skills kanban cards read candidate count from a different store than the preview API response. Ensure both use the same fallback when GitHub is unavailable:

In `app/skills-review/page.tsx` ‚Äî find where per-skill counts are set to 0 when no API response comes back, and apply the same heuristic fallback from `getFallbackSkillCount()`.

3. **Demo mode safety:** In demo mode, skip the live GitHub query entirely and inject known counts from the demo job profile (JavaScript: ~250k, TypeScript: ~180k, etc.)

---

## Bug 3 ‚Äî P1: `[Error] No 'tag_alias' match` for "Open Source"

### What the user sees
Console: `[Error] No 'tag_alias' match ‚ñ∏ (4) ['javascript', 'typescript', 'Node.js', 'Open Source']`

### Root cause
`lib/search/skillNormalizer.ts` ‚Äî `normalizeSkill()` doesn't know how to handle `"Open Source"` as a skill. It's a meta-concept, not a GitHub language or framework. The normalizer throws/logs an error when it can't map it.

### Fix
Add a special case in `normalizeSkill()`:
```ts
// In the normalizer map or early return:
const META_SKILLS = ['open source', 'open-source', 'oss'];
if (META_SKILLS.includes(input.toLowerCase())) {
  return null; // Signal: skip GitHub search for this "skill"
}
```

Then in the skills preview route, when `normalizeSkill()` returns `null`, use a high heuristic count (e.g. 500k) since "Open Source" contributors are everywhere on GitHub. Don't show "0 matches" for this.

---

## Bug 4 ‚Äî P1: Location filter (Denmark) has no visible effect

### What the user sees
- User adds üá©üá∞ Denmark to Hard Requirements
- "(0 of 0 candidates match)" ‚Äî unchanged
- No feedback that the filter was applied or is being evaluated

### Root cause (two parts)
**Part A ‚Äî Skills preview count query:** The `getSkillCandidateCount()` in the preview route accepts `location` param but the skills-review page may not be passing it when it refetches counts after a location is added.

**Part B ‚Äî Pipeline filter logic:** The hard requirements filter in `app/pipeline/page.tsx` around line 1044 checks:
```ts
if (req.type === 'language') {
  // Simple heuristic: check if language name appears in bio or location
  // In a real app, you'd have structured language data
```
The comment literally says "in a real app" ‚Äî this is a stub. Location filtering isn't actually querying GitHub location data or the candidate's stored location.

### Fix
- In skills-review: pass `location` to the preview API when hard requirements include a location, and refresh counts on location change
- In pipeline: filter `candidates` array by `candidate.location` field (check if it contains the country name, since GitHub location is a free-text field):
```ts
if (req.type === 'location' && candidate.location) {
  const loc = candidate.location.toLowerCase();
  return loc.includes(req.value.toLowerCase()) || 
         loc.includes('denmark') || // country aliases
         loc.includes('dk') ||
         loc.includes('copenhagen');
}
```

---

## Bug 5 ‚Äî P2: Misleading candidate counters

### What the user sees
- Header: **"15 candidates found"** (from GitHub search)
- Subheader: **"0 of 11"** (candidates in DB)  
- Main area: **"No Candidates Yet"**

All three numbers are different and contradictory. This is confusing even when nothing is broken.

### Fix
Show a single consistent count. The pipeline should display only the candidates that are actually available in the current view ‚Äî don't show the GitHub search count in the header if they haven't been saved successfully.

---

## Blocked Requests Warning in Console

### What the user sees
```
‚ö† This request has been blocked... was processed using the protocol but not used actively.
Please make sure it has an appropriate 'as' value...
```

### Root cause
This is a **browser preload warning** ‚Äî a CSS or JS chunk is being preloaded via `<link rel="preload">` but not used within the load event window. This is a Next.js/Turbopack build artifact. **Not a functionality bug**, but noisy.

### Fix
Add to `next.config.js`:
```js
experimental: {
  optimizePackageImports: ['...']
}
```
Or suppress preload hints for the affected chunks. Low priority.

---

## Fix Order (Recommended)

| # | Bug | File(s) | Effort |
|---|-----|---------|--------|
| 1 | 401 on POST /api/candidates | `app/api/candidates/route.ts`, `app/pipeline/page.tsx` | 1‚Äì2h |
| 2 | Verify GITHUB_TOKEN in Vercel env | Vercel dashboard (no code) | 5 min |
| 3 | Skills preview 0-count fallback | `app/skills-review/page.tsx`, `app/api/skills/preview/route.ts` | 2h |
| 4 | `tag_alias` error for "Open Source" | `lib/search/skillNormalizer.ts` | 30 min |
| 5 | Location filter logic | `app/pipeline/page.tsx` (~line 1044), `app/skills-review/page.tsx` | 2h |
| 6 | Misleading counters | `app/pipeline/page.tsx` header section | 30 min |

**Start with #1 + #2 ‚Äî they're independent and together will unblock the entire pipeline flow.**

---

## How to Reproduce

1. Go to `https://recruitos.xyz`
2. Click "Try Demo Data ‚Üí"
3. Open DevTools ‚Üí Console
4. Navigate to Skills Review ‚Üí observe "no matches" on all skills
5. Navigate to Pipeline ‚Üí observe 401 flood in console + empty candidate list

**Expected:** Demo loads pre-seeded candidates, pipeline shows them without auth, skills show realistic counts.

---

*Brief generated: 2026-02-18 | Based on: screen recording file_480, codebase branch feature/recruitos-rethink-2026*
